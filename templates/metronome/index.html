{% load static %}
<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Metronome</title>
    <link rel="stylesheet" href="{% static 'css/metrosite.css' %}">
</head>
<body>
    <div class="theme-switcher">
        <button id="theme-toggle">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
    </div>

    <div class="metronome-container">
        <h1>–ú–µ—Ç—Ä–æ–Ω–æ–º</h1>

        <!-- –§–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <form method="post">
            {% csrf_token %}

            <div class="setting-group">
                <label>–†–∞–∑–º–µ—Ä —Ç–∞–∫—Ç–∞:</label>
                {{ form.beats_per_measure }} / {{ form.beat_unit }}
            </div>

            <div class="setting-group">
                <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å:</label>
                {{ form.volume }}%
            </div>

            <div class="setting-group">
                <label>BPM:</label>
                {{ form.bpm }}
            </div>

            <button type="submit" name="save_settings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </form>

        <!-- –ü—Ä–µ—Å–µ—Ç—ã —Ç–µ–º–ø–æ–≤ -->
        <div class="presets-section">
            <h3>üéµ –ü—Ä–µ—Å–µ—Ç—ã —Ç–µ–º–ø–æ–≤</h3>

            <div class="compact-presets">
                <select id="presets-dropdown" class="presets-dropdown">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç</option>
                    <optgroup label="–ö–ª–∞—Å—Å–∏–∫–∞">
                        <option value="60">Largo (60 BPM)</option>
                        <option value="72">Adagio (72 BPM)</option>
                        <option value="88">Andante (88 BPM)</option>
                        <option value="112">Moderato (112 BPM)</option>
                        <option value="140">Allegro (140 BPM)</option>
                        <option value="180">Presto (180 BPM)</option>
                    </optgroup>
                    <optgroup label="–†–æ–∫ –∏ –ø–æ–ø">
                        <option value="70">Rock Ballad (70 BPM)</option>
                        <option value="120">Rock Standard (120 BPM)</option>
                        <option value="85">Hip-Hop (85 BPM)</option>
                        <option value="128">Dance (128 BPM)</option>
                    </optgroup>
                    <optgroup label="–î–∂–∞–∑">
                        <option value="90">Slow Jazz (90 BPM)</option>
                        <option value="130">Medium Jazz (130 BPM)</option>
                        <option value="180">Upbeat Jazz (180 BPM)</option>
                    </optgroup>
                </select>

                <button id="apply-preset" class="apply-preset-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å –º–µ—Ç—Ä–æ–Ω–æ–º–∞ -->
        <div class="metronome-display">
            <div class="bpm-display">BPM: <span id="current-bpm">{{ settings.bpm }}</span></div>

            <!-- –û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º–ø–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω–æ –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->

            <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
            <button id="play-button">–ó–∞–ø—É—Å–∫</button>
            <button id="stop-button">–°—Ç–æ–ø</button>

            <!-- –ö–Ω–æ–ø–∫–∞ —Ç–∞–ø-—Ç–µ–º–ø–∞-->
            <button id="tap-tempo" class="tap-button">–¢–∞–ø-—Ç–µ–º–ø</button>
            <div id="tap-feedback" class="tap-feedback"></div>

            <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ª–µ–π -->
            <div class="beats-visualization">
                {% for beat in beats %}
                <div class="beat-indicator" id="beat-{{ forloop.counter }}"></div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JavaScript —Ñ–∞–π–ª–æ–≤ -->
    <script src="{% static 'js/metronome.js' %}"></script>
    <script src="{% static 'js/theme.js' %}"></script>
    <script src="{% static 'js/tap_tempo.js' %}"></script>
    <script src="{% static 'js/presets.js' %}"></script>
    <script src="{% static 'js/tempo_descriptions.js' %}"></script>


    <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è -->
    <script>
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ Django
        const metronomeSettings = {
            beatsPerMeasure: {{ settings.beats_per_measure }},
            bpm: {{ settings.bpm }},
            volume: {{ settings.volume }}
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ú–µ—Ç—Ä–æ–Ω–æ–º
            const metronome = new Metronome(metronomeSettings);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–ø-—Ç–µ–º–ø–∞
            const tapTempo = new TapTempo(metronome);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Å–µ—Ç–æ–≤
            const tempoPresets = new TempoPresets(metronome);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —Ç–µ–º–ø–æ–≤
            const tempoDescriptions = new TempoDescription();

            
            document.getElementById('play-button').addEventListener('click', () => {
                metronome.start();
            });

            document.getElementById('stop-button').addEventListener('click', () => {
                metronome.stop();
                tapTempo.reset(); // –°–±—Ä–æ—Å —Ç–∞–ø–æ–≤ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –º–µ—Ç—Ä–æ–Ω–æ–º–∞
            });

            const bpmField = document.querySelector('[name="bpm"]') || document.getElementById('id_bpm');
            if (bpmField) {
                bpmField.addEventListener('input', function() {
                    const newBpm = parseInt(this.value);
                    metronome.updateBpm(newBpm);
                    document.getElementById('current-bpm').textContent = this.value;

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ BPM
                    const event = new CustomEvent('bpmChanged', { detail: { bpm: newBpm } });
                    document.dispatchEvent(event);
                });
            }

            // –¢–µ–º–∞
            new ThemeSwitcher();
        });
    </script>
</body>
</html>