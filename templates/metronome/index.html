<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Metronome</title>
    <link rel="stylesheet" href="{% static 'css/metrosite.css' %}">
</head>
<body>
    <div class="metronome-container">
        <h1>Метроном</h1>

        <!-- Форма настроек -->
        <form method="post">
            {% csrf_token %}

            <!-- ритмический размер -->
            <div class="setting-group">
                <label>Размер такта:</label>
                {{ form.beats_per_measure }} / {{ form.beat_unit }}
            </div>

            <!-- Громкость -->
            <div class="setting-group">
                <label>Громкость</label>
                {{  form.volume }}%
            </div>

            <!-- BPM -->
            <div class="setting-group">
                <label>BPM:</label>
                {{ form.bpm }}
            </div>

            <button type="submit" name="save_settings">Сохранить настройки</button>
        </form>

        <!-- Область метронома -->
        <div class="metronome-display">
            <div class="bpm-display">BPM: <span id="current-bpm">{{ settings.bpm }}</span></div>
            <button id="play-button">Запуск</button>
            <button id="stop-button">Стоп</button>
        <!-- Визуализация долей -->
            <div class="beats-visualization">
                {% for beat in beats %}
                <div class="beat-indicator" id="beat-{{ forloop.counter }}"></div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        class Metronome {
            constructor() {
                console.log('Конструктор Metronome вызван');
                this.isPlaying = false;
                this.audioContext = null;
                this.currentNote = 0;
                this.beatsPerMeasure = {{ settings.beats_per_measure }};
                this.bpm = {{ settings.bpm }};
                this.intervalId = null;
            }

            // Инициализация аудио
            initAudio() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Воспроизведение звука
            playSound(volume = 0.5) {
                if (!this.audioContext) this.initAudio();

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                // Сильная доля - другой звук
                oscillator.frequency.setValueAtTime(this.currentNote === 0 ? 800 : 400, this.audioContext.currentTime);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(volume * {{ settings.volume }} / 100, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.1);

                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + 0.1);
            }

            // Основной цикл метронома
            start() {
                if (this.isPlaying) return;

                console.log('Запуск метронома', this.bpm, 'BPM');
                this.isPlaying = true;
                const interval = 60000 / this.bpm;  // BPM в миллисекунды

                this.intervalId = setInterval(() => {
                    this.playSound(this.currentNote === 0 ? 0.7 : 0.5);
                    this.updateVisualization();
                    this.currentNote = (this.currentNote + 1) % this.beatsPerMeasure;
                }, interval);
            }

            stop() {
                this.isPlaying = false;
                clearInterval(this.intervalId);
                this.currentNote = 0;
                this.resetVisualization();
            }

            // Обновление визуализации
            updateVisualization() {
                const indicators = document.querySelectorAll('.beat-indicator');
                indicators.forEach((indicator, index) =>  {
                    indicator.style.background = index === this.currentNote ? '#ff4444' : '#4444ff';
                });
            }

            resetVisualization() {
                const indicators = document.querySelectorAll('.beat-indicator');
                indicators.forEach(indicator => {
                    indicator.style.background = '#ccc';
                });
            }

            // Обновление BPM
            updateBpm(newBpm) {
                this.bpm = newBpm;
                if (this.isPlaying) {
                    this.stop();
                    this.start();
                }
            }
        }

        // Инициализация метронома
        document.addEventListener('DOMContentLoaded', function() {
            const metronome = new Metronome();
            let audioInitialized = false;

            function initAudioOnFirstClick() {
                if (!audioInitialized) {
                    metronome.initAudio();
                    audioInitialized = true;
                }
            }

            // Обработчик кнопок
            document.getElementById('play-button').addEventListener('click', () => {
                console.log('✅ Кнопка Запуск нажата!');
                initAudioOnFirstClick();
                metronome.start();
            });

            document.getElementById('stop-button').addEventListener('click', () => {
                console.log('✅ Кнопка Стоп нажата!');
                metronome.stop();
            });

            // Обновление BPM в реальном времени
            const bpmField = document.querySelector('[name="bpm"]') || document.getElementById('id_bpm');
                if (bpmField) {
                    bpmField.addEventListener('input', function () {
                        metronome.updateBpm(parseInt(this.value));
                        document.getElementById('current-bpm').textContent = this.value;
                    });
                }
        });
    </script>
</body>
</html>
