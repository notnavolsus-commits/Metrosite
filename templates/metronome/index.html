{% load static %}
<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Metronome</title>
    <link rel="stylesheet" href="{% static 'css/metrosite.css' %}">
</head>
<body>
    <div class="theme-switcher">
        <button id="theme-toggle">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
    </div>

    <div class="metronome-container">
        <h1>–ú–µ—Ç—Ä–æ–Ω–æ–º</h1>

        <!-- –§–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <form method="post">
            {% csrf_token %}

            <div class="setting-group">
                <label>–†–∞–∑–º–µ—Ä —Ç–∞–∫—Ç–∞:</label>
                {{ form.beats_per_measure }} / {{ form.beat_unit }}
            </div>

            <div class="setting-group">
                <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å:</label>
                {{ form.volume }}%
            </div>

            <div class="setting-group">
                <label>BPM:</label>
                {{ form.bpm }}
            </div>

            <button type="submit" name="save_settings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </form>

        <!-- –û–±–ª–∞—Å—Ç—å –º–µ—Ç—Ä–æ–Ω–æ–º–∞ -->
        <div class="metronome-display">
            <div class="bpm-display">BPM: <span id="current-bpm">{{ settings.bpm }}</span></div>

            <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
            <button id="play-button">–ó–∞–ø—É—Å–∫</button>
            <button id="stop-button">–°—Ç–æ–ø</button>

            <!-- –ö–Ω–æ–ø–∫–∞ —Ç–∞–ø-—Ç–µ–º–ø–∞-->
            <button id="tap-tempo" class="tap-button">–¢–∞–ø-—Ç–µ–º–ø</button>
            <div id="tap-feedback" class="tap-feedback"></div>

            <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ª–µ–π -->
            <div class="beats-visualization">
                {% for beat in beats %}
                <div class="beat-indicator" id="beat-{{ forloop.counter }}"></div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JavaScript —Ñ–∞–π–ª–æ–≤ -->
    <script src="{% static 'js/metronome.js' %}"></script>
    <script src="{% static 'js/theme.js' %}"></script>
    <script src="{% static 'js/tap_tempo.js' %}"></script>

    <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è -->
    <script>
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ Django
        const metronomeSettings = {
            beatsPerMeasure: {{ settings.beats_per_measure }},
            bpm: {{ settings.bpm }},
            volume: {{ settings.volume }}
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ú–µ—Ç—Ä–æ–Ω–æ–º
            const metronome = new Metronome(metronomeSettings);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–ø-—Ç–µ–º–ø–∞
            const tapTempo = new TapTempo(metronome);
            
            document.getElementById('play-button').addEventListener('click', () => {
                metronome.start();
            });

            document.getElementById('stop-button').addEventListener('click', () => {
                metronome.stop();
                tapTempo.reset(); // –°–±—Ä–æ—Å —Ç–∞–ø–æ–≤ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –º–µ—Ç—Ä–æ–Ω–æ–º–∞
            });

            const bpmField = document.querySelector('[name="bpm"]') || document.getElementById('id_bpm');
            if (bpmField) {
                bpmField.addEventListener('input', function() {
                    metronome.updateBpm(parseInt(this.value));
                    document.getElementById('current-bpm').textContent = this.value;
                });
            }

            // –¢–µ–º–∞
            new ThemeSwitcher();
        });
    </script>
</body>
</html>